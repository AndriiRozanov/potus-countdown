name: Bootstrap site (safe)
on:
  workflow_dispatch: {}
permissions:
  contents: write
jobs:
  make:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate static site via bootstrap.sh
        shell: bash
        run: |
          chmod +x bootstrap.sh 2>/dev/null || true
          if [[ -f bootstrap.sh ]]; then
            bash bootstrap.sh
          else
            echo "bootstrap.sh not found (не критично, але тоді файлів може не бути)."
          fi

      - name: Create language aliases (/en, /uk, /es, /fr, /de)
        shell: bash
        run: |
          set -e
          for code in en uk es fr de; do
            mkdir -p "$code"
            printf '%s\n' \
              '<!doctype html><meta charset="utf-8">' \
              "<meta http-equiv=\"refresh\" content=\"0; url=/index.html?lang=$code\">" \
              '<title>Redirecting…</title>' \
              > "$code/index.html"
          done

      - name: Commit generated files (exclude workflows)
        shell: bash
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git restore --staged .github/workflows/digest.yml 2>/dev/null || true
            git commit -m "bootstrap: generate static site"
            git push
          else
            echo "Nothing to commit."
          fi
